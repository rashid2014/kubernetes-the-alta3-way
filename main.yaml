---
- name: bootstrap 
  hosts: all
  roles:
   - name: bootstrap
     when: run_bootstrap

- name: Create cert directories 
  hosts: k8s-admin-hosts
  tasks: 
  - name: Create cert directories
    file: 
      path: "{{ item }}"
      state: directory
    with_items:
    - "{{ cert_dir }}"
    - "{{ config_dir }}"
    - "{{ csr_dir }}"

  - name: Install dependencies with get_url -> cfssl, cfssljson, kubectl
    get_url:
      url: "{{ item.url }}"
      dest: "{{ item.dest }}"
      mode: "{{ item.mode }}"
    with_items:
    - { url: "{{ cfssl_url }}", 
        dest: /usr/local/bin/cfssl, 
        mode: '0755' }
    - { url: "{{ cfssljson_url }}", 
        dest: /usr/local/bin/cfssljson, 
        mode: '0755' }
    - { url: "{{ kubectl.url }}",
        dest: "{{ kubectl.path }}",
        mode: '0755' }
    become: yes    
  
- name: make certs & gen configs
  hosts: k8s-admin-hosts
  roles:
   - name: make_certs
     when: run_makecerts

- name: Deploy certs 
  hosts: k8s-admin-hosts
  tasks: 
   - name: Deploy all keys to all admin nodes
     synchronize:
       src: "~/k8s-certs/"
       dest: "{{ cert_dir }}"
     when: run_makecerts

- name: kubeconfig 
  hosts: k8s-admin-hosts
  roles:
   - name: node_kube_config
     when: run_nodeconfig
   - name: localhost_config
     when: run_localconfig

- name: deploy etcd
  hosts: etcd
  gather_facts: True
  roles:
   - name: etcd
     when: run_etcd

- name: deploy k8s masters
  hosts: masters
  gather_facts: True
  roles:
   - name: master_install
     when: run_master

- name: deploy load balancers
  hosts: localhost,nodes
  gather_facts: False
  roles:
   - name: nginx_localhost_load_balancer
     when: run_nginx_lb
   - name: trusted_ca
     when: run_trusted_ca

- name: configure rbac
  hosts: localhost
  roles:
   - name: rbac
     when: run_rbac
     
- name: install containerd, kubelet, kube-proxy, and certs on NODES
  hosts: nodes
  gather_facts: False
  roles:
   - name: node_install
     when: run_nodes

- name: deploy k8s services
  hosts: k8s-admin-hosts
  gather_facts: False
  roles:
   - name: calico
     when: run_services
   - name: kube-dns
     when: run_services
